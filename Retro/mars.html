<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mars Retrograde Motion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin: 30px 0 40px;
        }

        h1 {
            color: #4da6ff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(77, 166, 255, 0.3);
        }

        .subtitle {
            color: #ffa64d;
            font-size: 1.3em;
            margin-top: 10px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: rgba(77, 166, 255, 0.2);
            color: #4da6ff;
            text-decoration: none;
            border-radius: 8px;
            border: 2px solid rgba(77, 166, 255, 0.4);
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(77, 166, 255, 0.4);
            transform: translateY(-2px);
        }

        .law-section {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(77, 166, 255, 0.2);
        }

        .law-description {
            margin: 20px 0;
            font-size: 1.05em;
            line-height: 1.8;
        }

        .canvas-container {
            background: rgba(10, 10, 26, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(77, 166, 255, 0.3);
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 5px;
            max-width: 100%;
            height: auto;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #4da6ff 0%, #0066cc 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(77, 166, 255, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.5);
        }

        .highlight {
            color: #ffa64d;
            font-weight: bold;
        }

        .info-box {
            background: rgba(77, 166, 255, 0.1);
            border-left: 4px solid #4da6ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        footer {
            text-align: center;
            margin: 50px 0 20px;
            color: #666;
            font-size: 0.9em;
        }
    
        /* Audio Player Styles */
        .audio-player {
            background: rgba(77, 166, 255, 0.15);
            border: 2px solid rgba(77, 166, 255, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .audio-player h3 {
            color: #4da6ff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .audio-controls button {
            background: linear-gradient(135deg, #4da6ff 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(77, 166, 255, 0.3);
            min-width: 100px;
        }

        .audio-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.5);
            background: linear-gradient(135deg, #357abd 0%, #2a5f99 100%);
        }

        .audio-controls button:active {
            transform: translateY(0);
        }

        .audio-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    
        .audio-caption {
            margin-top: 15px;
            padding: 12px 20px;
            background: rgba(10, 10, 26, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(77, 166, 255, 0.2);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .caption-text {
            color: #e0e0e0;
            font-size: 1em;
            line-height: 1.6;
            text-align: center;
            font-style: italic;
        }

        .caption-text.active {
            color: #4da6ff;
        }

    


    
.nav-button {
    padding: 14px 35px;
    background: linear-gradient(135deg, #b8c6db 0%, #8fa3bf 100%);
    color: #1a1a2e;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.nav-button:hover:not(:disabled) {
    background: linear-gradient(135deg, #8fa3bf 0%, #7a8fa8 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.nav-button:disabled {
    background: #555;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.5;
    color: #999;
}


        .student-info {
            background: rgba(20, 20, 35, 0.9);
            padding: 15px 40px;
            border-bottom: 2px solid rgba(77, 166, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .student-name {
            color: #4da6ff;
            font-size: 1.1em;
        }
        
        .student-score {
            color: #ffa64d;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .student-attempt {
            color: #9d9dff;
            font-size: 1em;
        }
        
        .student-timer {
            color: #4dffb8;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Student Info Banner -->
    <div class="student-info" id="studentBanner" style="display: none;">
        <div class="student-name">Student: <span id="displayName"></span> (<span id="displayID"></span>)</div>
        <div class="student-score">Score: <span id="displayScore">0</span></div>
        <div class="student-attempt" id="attemptDisplay" style="display: none;">Attempt: <span id="attemptNumber">1</span></div>
        <div class="student-timer" id="timerDisplay" style="display: none;">
            <span id="timeWarningMessage" style="color: #ff4444; margin-right: 10px; font-weight: bold; display: none;"></span>
            Time Remaining: <span id="timeRemaining"></span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Planetary Retrograde Motion - Mars</h1>
            <div class="subtitle">An Illusion Created by Earth Having a Different Orbital Speed Than Mars</div>
        </div>

        
        <!-- Audio Player -->
        <div class="audio-player">
            <h3>üéß Instructions</h3>
            <audio id="pageAudio" preload="auto">
                <source src="retrograde-mars.mp3" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
            <div class="audio-controls">
                <button id="startBtn" onclick="startAudio()">Start</button>
                <button id="stopBtn" onclick="stopAudio()">Stop</button>
                <button id="resumeBtn" onclick="resumeAudio()">Resume</button>
            </div>
            <div class="audio-caption">
                <div id="captionText" class="caption-text"></div>
            </div>
        </div>


        <div class="law-section">
            <div class="law-description">
                <p>As Earth orbits the Sun faster than Mars (on an inside track), there are times when Earth "laps" Mars. During these periods, <span class="highlight">Mars appears to move backward (clockwise or retrograde motion)</span> relative to the background stars, even though both planets are always moving forward (counterclockwise) around the Sun.</p>
                <p>This animation shows how Mars's position changes against the distant starry background as viewed from Earth. The colored dot on the star ring shows where Mars (red-brown) appears to be in the night sky at different times during Earth's orbit.</p>
            </div>
            <div class="canvas-container">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div style="display: flex; flex-direction: column; gap: 20px; min-width: 200px;">
                        <div style="background: rgba(77, 166, 255, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(77, 166, 255, 0.3); text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #4da6ff;">Orbital Periods</div>
                            <div style="font-size: 0.9em; line-height: 1.6;">
                                Earth: <span style="color: #4da6ff;">1.00 year</span><br>
                                Mars: <span style="color: #E27B58;">1.88 years</span>
                            </div>
                        </div>
                        <div class="controls" style="flex-direction: column; gap: 10px;">
                            <button onclick="toggleAnimation()" style="width: 100%;">Pause/Resume</button>
                            <button id="speedButton" onclick="slowDown()" style="width: 100%;">Slow Down</button>
                            <button onclick="resetAnimation()" style="width: 100%;">Reset</button>
                            <button onclick="toggleFullscreen()" style="width: 100%;">Fullscreen</button>
                        </div>
                        <div class="legend" style="flex-direction: column; align-items: center; gap: 12px; width: 100%;">
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #00FF00;"></div>
                                <span>Prograde (CCW)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #FF0000;"></div>
                                <span>Retrograde (CW)</span>
                            </div>
                        </div>
                    </div>
                    <canvas id="canvasRetrograde" width="1000" height="720"></canvas>
                </div>
            </div>
            <div class="info-box">
                üí° Watch as Earth (blue) catches up to and passes Mars (red-brown) on the inside track. The colored dot on the star ring shows where Mars currently appears against the background stars from Earth's perspective. The yellow line from Earth extends straight through Mars to the star field. Notice how the dot changes from green (prograde motion - moving counterclockwise) to red (retrograde motion - moving clockwise) and back to green as Earth laps Mars!
            </div>
        </div>

        
        <!-- Quiz Section -->
        <div class="quiz-container" style="margin-top: 50px; padding: 30px; background: rgba(255, 193, 7, 0.05); border: 2px solid #ffc107; border-radius: 12px;">
            <h2 style="color: #ffc107; font-size: 2em; margin-bottom: 30px; text-align: center;">üìù Quiz Questions</h2>

            <!-- Question 1 -->
            <div class="quiz-question-block" style="margin-bottom: 35px; padding: 25px; background: rgba(30, 30, 50, 0.6); border-radius: 10px;">
                <div class="question-text" style="font-size: 1.2em; color: #e0e0e0; margin-bottom: 20px; font-weight: 500;">
                    <strong>Question 1:</strong> In terms of speed, which planet moves faster in its orbit, Mars or Earth? You can use the internet to discover the answer to this question.
                </div>
                <div class="quiz-options" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="quiz-option" data-question="1" data-option="0" onclick="handleQuizAnswer(3, 0, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>A)</strong> Earth
                    </div>
                    <div class="quiz-option" data-question="1" data-option="1" onclick="handleQuizAnswer(3, 1, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>B)</strong> Mars
                    </div>
                    <div class="quiz-option" data-question="1" data-option="2" onclick="handleQuizAnswer(3, 2, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>C)</strong> They move at the same speed
                    </div>
                </div>
                <div class="quiz-feedback" id="feedback-1" style="margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 1.05em; display: none;"></div>
            </div>

            <!-- Question 2 -->
            <div class="quiz-question-block" style="margin-bottom: 35px; padding: 25px; background: rgba(30, 30, 50, 0.6); border-radius: 10px;">
                <div class="question-text" style="font-size: 1.2em; color: #e0e0e0; margin-bottom: 20px; font-weight: 500;">
                    <strong>Question 2:</strong> When in its orbit does Mars exhibit retrograde motion as seen by an Earthbound observer? You can use the internet to discover the answer to this question.
                </div>
                <div class="quiz-options" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="quiz-option" data-question="2" data-option="0" onclick="handleQuizAnswer(4, 0, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>A)</strong> When Mars is in Opposition to Earth
                    </div>
                    <div class="quiz-option" data-question="2" data-option="1" onclick="handleQuizAnswer(4, 1, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>B)</strong> When Mars is in Conjunction with Earth
                    </div>
                    <div class="quiz-option" data-question="2" data-option="2" onclick="handleQuizAnswer(4, 2, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>C)</strong> When Earth and Mars are ninety degrees apart in their orbital positions
                    </div>
                    <div class="quiz-option" data-question="2" data-option="3" onclick="handleQuizAnswer(4, 3, 0)" style="background: rgba(20, 20, 35, 0.8); padding: 15px 20px; border-radius: 8px; border: 2px solid rgba(77, 166, 255, 0.3); cursor: pointer; transition: all 0.3s ease; color: #d0d0d0;">
                        <strong>D)</strong> It seems to happen at arbitrary times
                    </div>
                </div>
                <div class="quiz-feedback" id="feedback-2" style="margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 1.05em; display: none;"></div>
            </div>
        </div>

    </div>


    <script>
        const canvas = document.getElementById('canvasRetrograde');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 1000;
        canvas.height = 720;
        
        // Shift center to the right to make room for left sidebar
        const centerX = canvas.width / 2 + 50;
        const centerY = canvas.height / 2;
        
        // Planet configurations - fixed distances
        const earthConfig = {
            distance: 180,
            angle: Math.PI, // Start at left
            color: '#4A90E2',
            size: 12,
            period: 1.0,
            name: 'Earth'
        };
        
        const marsConfig = {
            distance: 225,
            angle: Math.PI, // Start at same position
            color: '#E27B58',
            size: 10,
            period: 1.88,
            name: 'Mars'
        };
        
        // Star ring configuration - many more stars for cloud effect
        const starRingRadius = 320;
        const numStars = 800; // Many stars for cloud effect
        const stars = [];
        
        // Initialize stars
        for (let i = 0; i < numStars; i++) {
            const angle = (Math.PI * 2 * i) / numStars + (Math.random() - 0.5) * 0.05;
            const radiusVariation = (Math.random() - 0.5) * 60;
            const radius = starRingRadius + radiusVariation;
            stars.push({
                x: centerX + radius * Math.cos(angle),
                y: centerY + radius * Math.sin(angle),
                size: Math.random() * 1.2 + 0.3,
                opacity: Math.random() * 0.4 + 0.3
            });
        }
        
        // Current Mars position marker - ONLY ONE DOT
        let currentMarker = null;
        let frameCount = 0;
        let animating = true;
        let animationSpeed = 1.0; // 1.0 = normal speed (10 sec/orbit), 0.67 = slow (15 sec/orbit)
        
        // For detecting retrograde motion
        let lastMarsAngle = null;
        
        function calculateApparentMarsPosition() {
            // Position of Mars
            const marsX = centerX + marsConfig.distance * Math.cos(marsConfig.angle);
            const marsY = centerY + marsConfig.distance * Math.sin(marsConfig.angle);
            
            // Position of Earth
            const earthX = centerX + earthConfig.distance * Math.cos(earthConfig.angle);
            const earthY = centerY + earthConfig.distance * Math.sin(earthConfig.angle);
            
            // Direction from Earth to Mars
            const dx = marsX - earthX;
            const dy = marsY - earthY;
            const angle = Math.atan2(dy, dx);
            
            // Check if Mars is visible (line doesn't pass through Sun)
            const lineLength = Math.sqrt(dx * dx + dy * dy);
            const dotProduct = -(earthX - centerX) * dx - (earthY - centerY) * dy;
            const t = Math.max(0, Math.min(1, dotProduct / (lineLength * lineLength)));
            
            const closestX = earthX + t * dx;
            const closestY = earthY + t * dy;
            const distToSun = Math.sqrt((closestX - centerX) ** 2 + (closestY - centerY) ** 2);
            
            const visible = distToSun > 35; // Sun radius is 30, add margin
            
            return {
                angle: angle,
                visible: visible,
                marsX: marsX,
                marsY: marsY,
                earthX: earthX,
                earthY: earthY
            };
        }
        
        function getMotionType(currentAngle, previousAngle) {
            if (previousAngle === null) return 'initial';
            
            // Normalize angles
            let diff = currentAngle - previousAngle;
            
            // Handle angle wrapping
            if (diff > Math.PI) diff -= 2 * Math.PI;
            if (diff < -Math.PI) diff += 2 * Math.PI;
            
            // CORRECTED: Negative diff means moving CCW (prograde)
            // Positive diff means moving CW (retrograde)
            if (Math.abs(diff) < 0.001) return 'stationary';
            return diff < 0 ? 'prograde' : 'retrograde';
        }
        
        function drawStarRing() {
            // Draw cloudy star ring - many small stars for smear effect
            stars.forEach((star, index) => {
                // Twinkling effect
                const twinkle = Math.sin(frameCount * 0.05 + index * 0.1) * 0.15;
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity + twinkle})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Draw very faint ring outline
            ctx.strokeStyle = 'rgba(100, 100, 150, 0.15)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(centerX, centerY, starRingRadius, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        function drawCurrentMarker() {
            if (!currentMarker || !currentMarker.visible) return;
            
            // Scintillating effect
            const scintillate = Math.sin(frameCount * 0.1) * 0.3 + 0.7;
            
            // Draw the single dot - larger and more prominent
            ctx.fillStyle = currentMarker.color.replace('1)', `${scintillate})`);
            ctx.beginPath();
            ctx.arc(currentMarker.x, currentMarker.y, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Outer glow
            const gradient = ctx.createRadialGradient(currentMarker.x, currentMarker.y, 0, currentMarker.x, currentMarker.y, 16);
            gradient.addColorStop(0, currentMarker.color.replace('1)', `${0.6})`));
            gradient.addColorStop(1, currentMarker.color.replace('1)', '0)'));
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(currentMarker.x, currentMarker.y, 16, 0, Math.PI * 2);
            ctx.fill();
            
            // Arrow TANGENT to the star ring (perpendicular to radius)
            // The radius angle is from center to marker
            const radiusAngle = Math.atan2(currentMarker.y - centerY, currentMarker.x - centerX);
            
            // Tangent is perpendicular to radius
            // CORRECTED: Prograde (green) goes CCW, retrograde (red) goes CW
            const arrowLength = 15;
            const tangentAngle = currentMarker.type === 'prograde' ? 
                radiusAngle - Math.PI / 2 :  // CCW tangent (subtract for CCW)
                radiusAngle + Math.PI / 2;   // CW tangent (add for CW)
            
            ctx.strokeStyle = currentMarker.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(currentMarker.x, currentMarker.y);
            ctx.lineTo(
                currentMarker.x + arrowLength * Math.cos(tangentAngle),
                currentMarker.y + arrowLength * Math.sin(tangentAngle)
            );
            ctx.stroke();
            
            // Arrowhead
            const headSize = 6;
            ctx.beginPath();
            ctx.moveTo(
                currentMarker.x + arrowLength * Math.cos(tangentAngle),
                currentMarker.y + arrowLength * Math.sin(tangentAngle)
            );
            ctx.lineTo(
                currentMarker.x + (arrowLength - headSize) * Math.cos(tangentAngle + 0.3),
                currentMarker.y + (arrowLength - headSize) * Math.sin(tangentAngle + 0.3)
            );
            ctx.moveTo(
                currentMarker.x + arrowLength * Math.cos(tangentAngle),
                currentMarker.y + arrowLength * Math.sin(tangentAngle)
            );
            ctx.lineTo(
                currentMarker.x + (arrowLength - headSize) * Math.cos(tangentAngle - 0.3),
                currentMarker.y + (arrowLength - headSize) * Math.sin(tangentAngle - 0.3)
            );
            ctx.stroke();
        }
        
        function drawPlanet(config) {
            const planetX = centerX + config.distance * Math.cos(config.angle);
            const planetY = centerY + config.distance * Math.sin(config.angle);
            
            // Draw orbit
            ctx.strokeStyle = config.color + '66';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, config.distance, 0, Math.PI * 2);
            ctx.stroke();
            
            // Draw planet
            ctx.fillStyle = config.color;
            ctx.beginPath();
            ctx.arc(planetX, planetY, config.size, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw label
            ctx.fillStyle = '#e0e0e0';
            ctx.font = 'bold 14px Arial';
            const textWidth = ctx.measureText(config.name).width;
            ctx.fillText(config.name, planetX - textWidth/2, planetY - config.size - 8);
        }
        
        function drawSightLine() {
            const apparent = calculateApparentMarsPosition();
            
            if (apparent.visible) {
                // The line goes from Earth, through Mars, and extends to the star ring
                // We already have earthX, earthY, marsX, marsY from apparent
                // We need to extend this line until it hits the star ring
                
                const dx = apparent.marsX - apparent.earthX;
                const dy = apparent.marsY - apparent.earthY;
                const angle = Math.atan2(dy, dx);
                
                // Find where the line from Earth at this angle intersects the star ring
                // Star ring is a circle of radius starRingRadius centered at centerX, centerY
                // Line starts at (earthX, earthY) in direction (dx, dy)
                // We need to find t such that the point is on the star ring:
                // (earthX + t*dx - centerX)^2 + (earthY + t*dy - centerY)^2 = starRingRadius^2
                
                const a = dx * dx + dy * dy;
                const b = 2 * (dx * (apparent.earthX - centerX) + dy * (apparent.earthY - centerY));
                const c = (apparent.earthX - centerX) ** 2 + (apparent.earthY - centerY) ** 2 - starRingRadius ** 2;
                
                const discriminant = b * b - 4 * a * c;
                if (discriminant >= 0) {
                    // Take the positive t (the one going away from Earth towards Mars)
                    const t1 = (-b + Math.sqrt(discriminant)) / (2 * a);
                    const t2 = (-b - Math.sqrt(discriminant)) / (2 * a);
                    const t = Math.max(t1, t2); // Take the farther intersection
                    
                    const starX = apparent.earthX + t * dx;
                    const starY = apparent.earthY + t * dy;
                    
                    // Draw STRAIGHT line from Earth to star ring intersection
                    ctx.strokeStyle = 'rgba(255, 255, 100, 0.6)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([10, 5]);
                    ctx.beginPath();
                    ctx.moveTo(apparent.earthX, apparent.earthY);
                    ctx.lineTo(starX, starY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // Return the star intersection point for the marker
                    return { x: starX, y: starY, angle: angle };
                }
            }
            return null;
        }
        
        function drawScene() {
            // Clear canvas
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Sun
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // Sun glow
            const gradient = ctx.createRadialGradient(centerX, centerY, 20, centerX, centerY, 60);
            gradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
            gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 60, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw star ring
            drawStarRing();
            
            // Draw sight line from Earth through Mars to star ring
            // This returns the actual star ring intersection point
            const sightLineResult = drawSightLine();
            
            // Draw current marker on star ring
            drawCurrentMarker();
            
            // Draw planets
            drawPlanet(earthConfig);
            drawPlanet(marsConfig);
            
            // Update positions and current marker
            if (animating) {
                earthConfig.angle -= (0.02 / earthConfig.period) * animationSpeed;
                marsConfig.angle -= (0.02 / marsConfig.period) * animationSpeed;
                
                // Update current marker every frame
                const apparent = calculateApparentMarsPosition();
                
                if (apparent.visible && sightLineResult) {
                    const motionType = getMotionType(sightLineResult.angle, lastMarsAngle);
                    
                    let color;
                    if (motionType === 'retrograde') {
                        color = 'rgba(255, 0, 0, 1)'; // Red for retrograde (CW)
                    } else {
                        color = 'rgba(0, 255, 0, 1)'; // Green for prograde (CCW)
                    }
                    
                    currentMarker = {
                        x: sightLineResult.x,
                        y: sightLineResult.y,
                        angle: sightLineResult.angle,
                        color: color,
                        type: motionType === 'retrograde' ? 'retrograde' : 'prograde',
                        visible: true
                    };
                    
                    lastMarsAngle = sightLineResult.angle;
                } else {
                    // Mars not visible - hide marker
                    if (currentMarker) {
                        currentMarker.visible = false;
                    }
                }
                
                frameCount++;
            }
            
            requestAnimationFrame(drawScene);
        }
        
        function toggleAnimation() {
            animating = !animating;
        }
        
        function resetAnimation() {
            earthConfig.angle = Math.PI;
            marsConfig.angle = Math.PI;
            currentMarker = null;
            lastMarsAngle = null;
            frameCount = 0;
            animationSpeed = 1.0; // Reset to normal speed
            document.getElementById('speedButton').textContent = 'Slow Down'; // Reset button text
        }
        
        function slowDown() {
            const speedButton = document.getElementById('speedButton');
            // Toggle between normal speed (1.0 = ~10 sec/orbit) and slow speed (0.67 = ~15 sec/orbit)
            if (animationSpeed === 1.0) {
                animationSpeed = 0.67;
                speedButton.textContent = 'Speed Up';
            } else {
                animationSpeed = 1.0;
                speedButton.textContent = 'Slow Down';
            }
        }
        
        function toggleFullscreen() {
            const container = canvas.parentElement.parentElement;
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ESC key exits fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
        });
        
        // Start animation
        drawScene();
    

        const audio = document.getElementById('pageAudio');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resumeBtn = document.getElementById('resumeBtn');

        // Auto-play audio when page loads
        window.addEventListener('load', function() {
            // Delay audio by 0.8s to prevent first words from being clipped
            setTimeout(function() {
                if (audio.readyState >= 2) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Autoplay prevented'));
                } else {
                    audio.addEventListener('canplay', function() {
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Autoplay prevented'));
                    }, { once: true });
                }
            }, 800);
        });

        function startAudio() {
            // Ensure audio is ready before playing
            if (audio.readyState >= 2) {
                audio.currentTime = 0;
                audio.play();
            } else {
                audio.load();
                audio.addEventListener('canplay', function() {
                    audio.currentTime = 0;
                    audio.play();
                }, { once: true });
            }
        }

        function stopAudio() {
            audio.pause();
        }

        function resumeAudio() {
            audio.play();
        }

        // Update button states based on audio state
        audio.addEventListener('play', function() {
            startBtn.disabled = false;
            stopBtn.disabled = false;
            resumeBtn.disabled = true;
        });

        audio.addEventListener('pause', function() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            resumeBtn.disabled = false;
        });

        audio.addEventListener('ended', function() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            resumeBtn.disabled = true;
        });


        // Transcript data with timing
        const transcript = "On this page we see Mars as a superior planet, meaning it is farther from the Sun than the Earth, exhibiting planetary retrograde motion. The way this animation works, when someone on Earth views Mars moving forward, that is to say prograde, or counterclockwise in its orbit relative to the unmovable faraway background stars, the animation indicates that motion with a green dot and forward arrow movement on the starry ring. But when someone on Earth sees Mars moving backward, that is to say retrograde, or clockwise in its orbit relative to the unmovable faraway background stars, the animation indicates that motion with a red dot and backward arrow movement on the starry ring. In keeping with Kepler's Third Law of Planetary Motion, Earth moves faster in its orbit than Mars does, because Earth is closer to the Sun than Mars is. Notice that Mars only shows planetary retrograde motion when Earth laps it. This happens around the time that Mars is in Opposition to Earth, that is to say, the Sun, Earth and Mars are lined up, with Earth in the middle. Notice also that the dotted yellow line of sight connecting Earth, Mars and the starry ring disappears when Mars goes behind the Sun and becomes invisible. We say that Mars is at or near Conjunction with Earth. Otherwise, the dotted yellow line is always present, because Mars can otherwise always be seen. As stated before, when Earth passes, or laps Mars on the inside track, Mars appears to go retrograde or backwards relative to the starry background, even though Mars is actually still going forward. This is an illusion. Try using the animation control buttons on the left side. You can slow down the animation to better observe Mars' retrograde motion, and you can also switch to full screen viewing of the animation to better observe that retrograde motion. When you are all finished exploring this animation, be sure to answer the question or questions at the bottom of this web page. Then click on the Venus retrograde motion link.";
        const captionElement = document.getElementById('captionText');
        
        // Function to update caption based on audio progress
        function updateCaption() {
            if (audio.currentTime > 0 && !audio.paused) {
                captionElement.textContent = transcript;
                captionElement.classList.add('active');
            } else {
                captionElement.textContent = '';
                captionElement.classList.remove('active');
            }
        }
        
        // Update caption as audio plays
        audio.addEventListener('timeupdate', updateCaption);
        
        audio.addEventListener('play', function() {
            updateCaption();
        });
        
        audio.addEventListener('pause', function() {
            captionElement.classList.remove('active');
        });
        
        audio.addEventListener('ended', function() {
            captionElement.textContent = '';
            captionElement.classList.remove('active');
        });


    </script>

    <script>
        // Audio functionality
        const audioMars = document.getElementById('pageAudio');
        const startBtnMars = document.getElementById('startBtn');
        const stopBtnMars = document.getElementById('stopBtn');
        const resumeBtnMars = document.getElementById('resumeBtn');

        // Autoplay is handled by the first window.addEventListener('load') above

        function startAudio() {
            if (audioMars) {
                audioMars.currentTime = 0;
                audioMars.play();
            }
        }

        function stopAudio() {
            if (audioMars) audioMars.pause();
        }

        function resumeAudio() {
            if (audioMars) audioMars.play();
        }

        if (audioMars) {
            audioMars.addEventListener('play', function() {
                if (startBtnMars) startBtnMars.disabled = false;
                if (stopBtnMars) stopBtnMars.disabled = false;
                if (resumeBtnMars) resumeBtnMars.disabled = true;
            });
            audioMars.addEventListener('pause', function() {
                if (startBtnMars) startBtnMars.disabled = false;
                if (stopBtnMars) stopBtnMars.disabled = true;
                if (resumeBtnMars) resumeBtnMars.disabled = false;
            });
            audioMars.addEventListener('ended', function() {
                if (startBtnMars) startBtnMars.disabled = false;
                if (stopBtnMars) stopBtnMars.disabled = true;
                if (resumeBtnMars) resumeBtnMars.disabled = true;
            });
        }

    </script>

    <!-- Load shared logic -->
    <script src="retro-shared.js"></script>

        <!-- Navigation -->
        <div class="navigation" style="display: flex; justify-content: space-between; align-items: center; padding: 25px 40px; background: rgba(20, 20, 35, 0.8); border-top: 2px solid rgba(77, 166, 255, 0.3);">
            <button class="nav-button"  onclick="window.location.href='copernicus.html'" >‚Üê Previous</button>
            <div class="page-counter" style="font-size: 1.2em; color: #4da6ff; font-weight: 600;">
                <span>3</span> / <span>5</span>
            </div>
            <button class="nav-button"  onclick="window.location.href='venus.html'" >Next ‚Üí</button>
        </div>
        
        <div class="timeline-indicator" style="display: flex; justify-content: center; gap: 10px; padding: 20px; background: rgba(20, 20, 35, 0.5);">
            <div class="timeline-dot" onclick="window.location.href='intro.html'" style="width: 14px; height: 14px; border-radius: 50%; background: rgba(77, 166, 255, 0.3); transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; transform: scale(1); box-shadow: none;"></div>
            <div class="timeline-dot" onclick="window.location.href='copernicus.html'" style="width: 14px; height: 14px; border-radius: 50%; background: rgba(77, 166, 255, 0.3); transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; transform: scale(1); box-shadow: none;"></div>
            <div class="timeline-dot active" onclick="window.location.href='mars.html'" style="width: 14px; height: 14px; border-radius: 50%; background: #4da6ff; transition: all 0.3s ease; cursor: pointer; border: 2px solid #fff; transform: scale(1.4); box-shadow: 0 0 15px rgba(77, 166, 255, 0.8);"></div>
            <div class="timeline-dot" onclick="window.location.href='venus.html'" style="width: 14px; height: 14px; border-radius: 50%; background: rgba(77, 166, 255, 0.3); transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; transform: scale(1); box-shadow: none;"></div>
            <div class="timeline-dot" onclick="window.location.href='outro.html'" style="width: 14px; height: 14px; border-radius: 50%; background: rgba(77, 166, 255, 0.3); transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; transform: scale(1); box-shadow: none;"></div>
        </div>
    
</body>
</html>
